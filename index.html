<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>VTVCAB</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom fonts for this template -->
    <link rel="stylesheet" href="vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="vendor/simple-line-icons/css/simple-line-icons.css">
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Catamaran:100,200,300,400,500,600,700,800,900" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Muli" rel="stylesheet">

    <!-- Plugin CSS -->
    <link rel="stylesheet" href="device-mockups/device-mockups.css">

    <!-- Custom styles for this template -->
    <link href="css/new-age.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
		<script src="https://www.gstatic.com/firebasejs/4.5.0/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/4.5.0/firebase-auth.js"></script>
		<script src="https://www.gstatic.com/firebasejs/4.5.0/firebase-database.js"></script>
		<script src="https://www.gstatic.com/firebasejs/4.5.0/firebase-firestore.js"></script>
		<script src="https://www.gstatic.com/firebasejs/4.5.0/firebase-messaging.js"></script>


  </head>

  <body id="page-top">
    <div class="wrapper_add_edit" id="wrapper_add_edit" style="height: 100%; padding-top: 0%">
      <div class="wrapper_form" id="wrapper_form" style="margin-top: 70px; ">
          <div class="close" style="padding-right: 10px; cursor: pointer;">
              <h3 style="float: right;">&times;</h3>
          </div>
          <div class="tab">
              <div class="tablinks tablinks_details" onclick="getGameDetails('round1')" id="defaultOpen">Hiệp 1</div>
              <div class="tablinks tablinks_manageUserSale" onclick="getGameDetails('round2')">Hiệp 2</div>
              <div class="tablinks tablinks_manageUserGroup" onclick="getGameDetails('all')">Tất cả</div>
          </div>
          <div id="London" class="tabcontent">
            <div class="nameclubs">
              <div class="wrapper_club" style="float: left; width: 50%;">
                <span>Đội nhà</span>
                <select class="homeclub club">
                </select>
              </div>
              <div class="wrapper_club" style="float: left">
                <span>Đội khách</span>
                <select class="awayclub club">
                </select>
              </div>
            </div>
            <div class="stadium">
            </div>
              <div class="wrapper_infor" style="padding-top: 25px;">
              </div><!--.wrapper_infor-->
          </div><!--.tabcontent-->
      </div><!--.wrapper_form-->
  </div><!--.wrapper_add_edit-->

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav" style="background: #0072C6;">
      <div class="container">
        <a class="navbar-brand js-scroll-trigger" href="#page-top">VTVCAB</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <!-- Menu -->
          <i class="fa fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="#download">Download</a>
            </li>
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="#features">Features</a>
            </li>
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="#contact">Contact</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <header class="masthead">
      <div class="container h-100">
        <div class="row h-100 " style="background: white; margin-top: 56px;">
          <div class="col-lg-12 " style="padding-top: 20px; padding-bottom: 20px; ">
            <button type="button" class="btn btn-primary btnAdd">Thêm mới</button>
          </div>
          <div class="col-lg-12 content">
            <div class="header-content mx-auto">
            </div>
          </div>
          <div class="col-lg-5 my-auto">
            <div class="device-container">
              <div class="device-mockup iphone6_plus portrait white">
                <div class="device">
                  <div class="screen">
                  </div>
                  <div class="button">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <footer>
      <div class="container">
        <p>&copy; 2017 Start Bootstrap. All Rights Reserved.</p>
        <ul class="list-inline">
          <li class="list-inline-item">
            <a href="#">Privacy</a>
          </li>
          <li class="list-inline-item">
            <a href="#">Terms</a>
          </li>
          <li class="list-inline-item">
            <a href="#">FAQ</a>
          </li>
        </ul>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/popper/popper.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for this template -->
    <script src="js/new-age.min.js"></script>
    <script>
    var config = {
      apiKey: "AIzaSyBpawnGQ1WPtyOHODWAxuyG9dy9yuUThOY",
      authDomain: "resultsgame.firebaseapp.com",
      databaseURL: "https://resultsgame.firebaseio.com",
      projectId: "resultsgame",
      storageBucket: "resultsgame.appspot.com",
      messagingSenderId: "1080413171479"
     };
   var gameId = "";
   var round = "round1"; // Mặc định hiển thị kết quả Hiệp 1
   var defaultApp = firebase.initializeApp(config);
   var defaultDatabase = defaultApp.database();
   var ref = defaultDatabase.ref("games");
   var h1 = document.getElementById('timehome'),
     start = document.getElementById('starthome'),
     seconds = 0, minutes = 0, hours = 0, secondsaway = 0, minutesaway = 0, hoursaway = 0,
     t,taway;
  //  var refFoul = defaultDatabase.ref("games/-Kw_yHgkmL0f0LZK0vyN").update({ awayname: "Chelsea" });
   // var refFoul = defaultDatabase.ref("games/-Kw_yHgkmL0f0LZK0vyN/name").set( "Chelsea" );
   loadClub();
  //  var refte = defaultDatabase.ref("clubs");
  //  var refclub = refte.push().set({
  //    "name": "Hà Nội",
  //    "stadium": "Hàng Đẫy",
  //    "national": "V League"
  //  });

   $('.close').click(function(){
      $('.wrapper_add_edit').css("display", "none");
      clearTimeout(t);
      clearTimeout(taway);
   });
   $('.btnAdd').click(function(){
      $('.wrapper_add_edit').css("display", "block");
      var refNew = ref.push().set({
      "awayname" : "",
      "createdate" : getToday(),
      "createuser" : "",
      "deleted" : 0,
      "homename" : "",
      "name" : "",
      "round1" : {
        "corners" : {
          "away" : 0,
          "home" : 0
        },
        "fouls" : {
          "away" : 0,
          "home" : 0
        },
        "goals" : {
          "away" : 0,
          "home" : 0
        },
        "offsides" : {
          "away" : 0,
          "home" : 0
        },
        "possession" : {
          "away" : "00:00:00",
          "home" : "00:00:00"
        },
        "redcard" : {
          "away" : 0,
          "home" : 0
        },
        "shots" : {
          "away" : 0,
          "home" : 0
        },
        "shotsontarget" : {
          "away" : 0,
          "home" : 0
        },
        "yellowcard" : {
          "away" : 0,
          "home" : 0
        }
      },
      "round2" : {
        "corners" : {
          "away" : 0,
          "home" : 0
        },
        "fouls" : {
          "away" : 0,
          "home" : 0
        },
        "goals" : {
          "away" : 0,
          "home" : 0
        },
        "offsides" : {
          "away" : 0,
          "home" : 0
        },
        "possession" : {
          "away" : "00:00:00",
          "home" : "00:00:00"
        },
        "redcard" : {
          "away" : 0,
          "home" : 0
        },
        "shots" : {
          "away" : 0,
          "home" : 0
        },
        "shotsontarget" : {
          "away" : 0,
          "home" : 0
        },
        "yellowcard" : {
          "away" : 0,
          "home" : 0
        }
      },
      "stadium" : "",
      "updatedate" : "",
      "updateuser" : ""
    });
      ref.limitToLast(1).on("child_added", function(snapshot, prevChildKey) {
        var newPost = snapshot.val();
        gameId =  snapshot.key;
        getGameDetails('round1');
        // console.log("Previous Post ID: " + prevChildKey);
      });
   });

   // Attach an asynchronous callback to read the data at our posts reference
   ref.on("value", function(snapshot) {
   	var newPost=snapshot.val();
   	var str = "";
    str += '<table style="width:100%">';
    str += '<tr>';
    str += '<th>Trận đấu</th>';
    str += '<th>Thời gian</th>';
    str += '<th>Sân vận động</th>';
    str += '<th>Hành động</th>';
    str += '</tr>';
   		snapshot.forEach(function(childSnapshot) {
      if(childSnapshot.val().deleted == "0")
      {
        str += '<tr>';
        str += '<td>'+childSnapshot.val().name+'</td>';
        str += '<td>'+childSnapshot.val().createdate+'</td>';
        str += '<td>'+childSnapshot.val().stadium+'</td>';
        str += '<td><img title="Sửa" onclick="editGameDetails(\'' + childSnapshot.key + '\')" style="height: 25px; width: 25px;cursor:pointer;" class="img_delete" src="img/edit1.png"/><img title="Xóa" onclick="deleteUser(\'' + 2+ '\',\'Bạn muốn xóa số điện thoại này?\')" style="height: 25px; width: 25px; cursor:pointer;" class="img_delete" src="img/delete1.png"/></td>';
        str += '</tr>';
      }

     });
     str += '</table>';
     $('.content').html(str);
   });

   function getToday(){
      var today = new Date();
      var dd = today.getDate();
      var mm = today.getMonth()+1; //January is 0!
      var yyyy = today.getFullYear();
      var mn = today.getMinutes();
      var h = today.getHours();
      if(dd<10) {
        dd = '0'+dd
      }
      if(mm<10) {
        mm = '0'+mm
      }
      return today = dd + '/' + mm + '/' + yyyy + ' ' +h+ ':'+mn;
   }
   function openCity(evt, cityName, round) {
      var i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
      }
      tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(cityName).style.display = "block";
      evt.currentTarget.className += " active";

  }
  function getGameDetails(roundchange){
    round = roundchange;
    clearTimeout(t);
    clearTimeout(taway);
    var refRound = defaultDatabase.ref("games/"+gameId+"/"+round);

    refRound.on("value", function(snapshot) {
      var arrStr = "";
      var arrPossession = "";

      arrStr += '<table style="width: 96%;margin-left: 2%;margin-right: 2%;">';
      arrStr += '<tr>';
      arrStr += '<td colspan="3" style=" padding: 5px 0px; text-align: center;">Hà Nội ACB</td>';
      arrStr += '<td colspan="1" style=" text-align: center; padding: 5px 0px;"></td>';
      arrStr += '<td colspan="3" style="padding: 5px 0px; text-align: center;">Hải Phòng</td>';
      arrStr += '</tr>';
      snapshot.forEach(function(e){
        if (e.key == "possession") {
          var valHome = validatePossession('home',e.val().away, e.val().home);
          var valAway = validatePossession('away',e.val().away, e.val().home);
          var arrHome = e.val().home.split(":");
          var arrAway = e.val().away.split(":");
          hours = Number(arrHome[0]); minutes = Number(arrHome[1]) ; seconds = Number(arrHome[2]);
          hoursaway = Number(arrAway[0]); minutesaway = Number(arrAway[1]) ; secondsaway = Number(arrAway[2]);

          arrPossession += '<tr>';
          arrPossession += '<td style="width: 10%; padding: 5px 0px; text-align: center;"><span class="possessionaway">'+valHome+'</span></td>';
          arrPossession += '<td style="width: 15%; text-align: center; padding: 5px 0px;"><span id="timehome"><time>'+e.val().home+'</span></td>';
          arrPossession += '<td style="width: 10%; padding: 5px 0px; text-align: center;"><img title="" onclick="timer()" style="height: 25px; width: 25px;cursor:pointer;" id="starthome" class="img_delete" src="img/play.png"/></td>';
          arrPossession += '<td style="width: auto; text-align: center; padding: 5px 0px;">Kiểm soát bóng</td>';
          arrPossession += '<td style="width: 10%; padding: 5px 0px; text-align: center;"><img title="" onclick="timeraway()" style="height: 25px; width: 25px;cursor:pointer;" class="img_delete" src="img/play.png"/></td>';
          arrPossession += '<td style="width: 15%; text-align: center; padding: 5px 0px;"><span id="timeraway" ><time>'+e.val().away+'</time></span></td>';
          arrPossession += '<td style="width: 10%; padding: 5px 0px; text-align: center;"><span class="possessionaway">'+valAway+'</span></td>';
          arrPossession += '</tr>';
          arrPossession += '<tr><td colspan="8" style="padding: 5px 0px; text-align: center;"><img title="" onclick="pauseTime()" style="height: 40px; width: 40px;cursor:pointer;" id="starthome" class="img_delete" src="img/pause.png"/></td></tr>';
        }
        else {
          var validateKey = "";
          if(e.key == "corners") validateKey = "Phạt góc";
          if(e.key == "fouls") validateKey = "Phạm lỗi";
          if(e.key == "goals") validateKey = "Bàn thắng";
          if(e.key == "offsides") validateKey = "Việt vị";
          if(e.key == "possession") validateKey = "Kiểm soát bóng";
          if(e.key == "redcard") validateKey = "Thẻ đỏ";
          if(e.key == "shots") validateKey = "Cú sút";
          if(e.key == "shotsontarget") validateKey = "Cú sút trúng đích";
          if(e.key == "yellowcard") validateKey = "Thẻ vàng";
          arrStr += '<tr>';
          arrStr += '<td style="width: 10%; padding: 5px 0px; text-align: center;"><img title="Giảm" onclick="updateGameDetails(\'home\',\''+ e.key +'\',\''+(Number(e.val().home)-1)+'\')" style="height: 25px; width: 25px;cursor:pointer;" class="img_delete" src="img/remove.png"/></td>';
          arrStr += '<td style="width: 15%; text-align: center; padding: 5px 0px;">'+ e.val().home +'</td>';
          arrStr += '<td style="width: 10%; padding: 5px 0px; text-align: center;"><img title="Tăng" onclick="updateGameDetails(\'home\',\''+ e.key +'\',\''+(Number(e.val().home)+1)+'\')" style="height: 25px; width: 25px;cursor:pointer;" class="img_delete" src="img/plus.png"/></td>';
          arrStr += '<td style="width: auto; text-align: center; padding: 5px 0px;">'+validateKey+'</td>';
          arrStr += '<td style="width: 10%; padding: 5px 0px; text-align: center;"><img title="Giảm" onclick="updateGameDetails(\'away\',\''+ e.key +'\',\''+(Number(e.val().away)-1)+'\')" style="height: 25px; width: 25px;cursor:pointer;" class="img_delete" src="img/remove.png"/></td>';
          arrStr += '<td style="width: 15%; text-align: center; padding: 5px 0px;">'+ e.val().away +'</td>';
          arrStr += '<td style="width: 10%; padding: 5px 0px; text-align: center;"><img title="Tăng" onclick="updateGameDetails(\'away\',\''+ e.key +'\',\''+(Number(e.val().away)+1)+'\')" style="height: 25px; width: 25px;cursor:pointer;" class="img_delete" src="img/plus.png"/></td>';
          arrStr += '</tr>';
        }

      });
      arrStr = arrStr + arrPossession;
      arrStr += '  </table>';
      $('.wrapper_infor').html(arrStr);
    });
  }
  function pauseTime(){
    clearTimeout(t);
    clearTimeout(taway);
  }
  // Sửa Game
  function editGameDetails(Id){
    gameId = Id;
    $('.wrapper_add_edit').css("display", "block");
    getGameDetails('round1');
  }
  function updateGameDetails(typeTeam, field, val){
    if(Number(val) >= 0)
    var refRound = defaultDatabase.ref("games/"+gameId+"/"+round+"/"+field+"/"+typeTeam).set(val);
  }
  function updateGamePossession(typeTeam, val){

    var refRound = defaultDatabase.ref("games/"+gameId+"/"+round+"/possession/"+typeTeam).set(val);
  }
  // Đếm giờ

  function add() {
      seconds++;
      if (seconds >= 60) {
          seconds = 0;
          minutes++;
          if (minutes >= 60) {
              minutes = 0;
              hours++;
          }
      }
      var display = (hours ? (hours > 9 ? hours : "0" + hours) : "00") + ":" + (minutes ? (minutes > 9 ? minutes : "0" + minutes) : "00") + ":" + (seconds > 9 ? seconds : "0" + seconds);
      updateGamePossession('home', display);
      $('#timehome').html(display) ;
      timer();
  }
function timer() {
    clearTimeout(taway);
    t = setTimeout(add, 1000);
  }
function validatePossession(typeTeam, possAway, possHome)
{
  var arrpossAway = possAway.split(":");
  var secondsaway = (+arrpossAway[0]) * 60 * 60 + (+arrpossAway[1]) * 60 + (+arrpossAway[2]);
  var arrpossHome = possHome.split(":");
  var secondshome = (+arrpossHome[0]) * 60 * 60 + (+arrpossHome[1]) * 60 + (+arrpossHome[2]);

  if ((secondsaway+secondshome) == 0) {
    return "00,00%";
  }
  if (typeTeam == "home" && possAway == 0) {
    return "100,00%";
  }
  if (typeTeam == "away" && possHome == 0) {
    return "100,00%";
  }
  var poss = (Number(secondshome)/(Number(secondsaway)+Number(secondshome)))*100;
  poss = Math.round(poss * 100) / 100;

  if (typeTeam == "home") {
    return poss+"%";
  }
  else {
    return (Math.round((100-poss) * 100)/100)+"%";
  }
}
function addaway() {
    secondsaway++;
    if (secondsaway >= 60) {
        secondsaway = 0;
        minutesaway++;
        if (minutesaway >= 60) {
            minutesaway = 0;
            hoursaway++;
        }
    }
    var display = (hoursaway ? (hoursaway > 9 ? hoursaway : "0" + hoursaway) : "00") + ":" + (minutesaway ? (minutesaway > 9 ? minutesaway : "0" + minutesaway) : "00") + ":" + (secondsaway > 9 ? secondsaway : "0" + secondsaway);
    updateGamePossession('away', display);
    // $('#timeraway').html(display) ;
    // var poss = (taway/(t+taway))*100;
    // poss = Math.round(poss * 100) / 100
    // // poss = Math.round(poss, 2);
    // $('.possessionaway').html(poss);
    timeraway();
}
function timeraway() {
    clearTimeout(t);
    taway = setTimeout(addaway, 1000);
  }

  /* Start button */

  /* Stop button */
  // stop.onclick = function() {
  //     clearTimeout(t);
  // }

  /* Clear button */
  // clear.onclick = function() {
  //     h1.textContent = "00:00:00";
  //     seconds = 0; minutes = 0; hours = 0;
  // }
  function loadClub(){
    var refClub = defaultDatabase.ref("clubs");
    refClub.on("value", function(snapshot) {
      var str = "" ;
      snapshot.forEach(function(e){
        str += '<option value="">'+e.val().name+'</option>';
      });
      $('.club').html(str);
    })
  }
     </script>

  </body>

</html>
